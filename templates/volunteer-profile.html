{% extends "base.html" %}

{% block title %}{{ volunteer.first_name }} {{ volunteer.last_name }} - Profile{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-header">
        <h1>{{ volunteer.first_name }} {{ volunteer.last_name }}</h1>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <span class="status-badge status-{{ volunteer.status }}">{{ volunteer.status|title }}</span>
            <a href="{{ url_for('dashboard.edit_volunteer', volunteer_id=volunteer.id) }}" class="btn btn-primary">Edit Info</a>
        </div>
    </div>

    <div class="profile-info">
        <div class="info-grid">
            <div class="info-item">
                <label>Status:</label>
                <span>{{ volunteer.status|title }}</span>
            </div>
            <div class="info-item">
                <label>Total Evaluations:</label>
                <span>{{ volunteer.evaluations.count() }}</span>
            </div>
        </div>
    </div>

    {% if stats %}
    <div class="stats-section">
        <h2>Performance Statistics</h2>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Evaluations</h3>
                <p class="stat-number">{{ stats.evaluation_count }}</p>
            </div>
            <div class="stat-card">
                <h3>Average Overall Rating</h3>
                <p class="stat-number">{{ "%.2f"|format(stats.average_overall) if stats.average_overall else 'N/A' }}</p>
            </div>
            {% if stats.trend %}
            <div class="stat-card">
                <h3>Trend</h3>
                <p class="stat-number trend-{{ stats.trend }}">{{ stats.trend|title }}</p>
            </div>
            {% endif %}
            {% if stats.recent_performance %}
            <div class="stat-card">
                <h3>Last 30 Days</h3>
                <p class="stat-number">{{ "%.2f"|format(stats.recent_performance) }}</p>
                <small style="color: #64748b;">{{ stats.recent_evaluation_count }} eval{{ 's' if stats.recent_evaluation_count != 1 else '' }}</small>
            </div>
            {% endif %}
        </div>
        
        {% if stats.work_again_summary and (stats.work_again_summary.Yes or stats.work_again_summary.No or stats.work_again_summary.Maybe) %}
        <div class="stat-card" style="margin-top: 1.5rem;">
            <h3>ü§ù Would Work With Again</h3>
            <div style="display: flex; gap: 2rem; margin-top: 0.75rem;">
                <div style="text-align: center;">
                    <span style="font-size: 1.75rem; font-weight: 700; color: #16a34a;">{{ stats.work_again_summary.Yes }}</span>
                    <p style="color: #64748b; font-size: 0.875rem; margin: 0;">Yes</p>
                </div>
                <div style="text-align: center;">
                    <span style="font-size: 1.75rem; font-weight: 700; color: #ea580c;">{{ stats.work_again_summary.Maybe }}</span>
                    <p style="color: #64748b; font-size: 0.875rem; margin: 0;">Maybe</p>
                </div>
                <div style="text-align: center;">
                    <span style="font-size: 1.75rem; font-weight: 700; color: #dc2626;">{{ stats.work_again_summary.No }}</span>
                    <p style="color: #64748b; font-size: 0.875rem; margin: 0;">No</p>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if stats.recommended_roles and stats.recommended_roles|length > 0 %}
        <div class="stat-card" style="margin-top: 1.5rem;">
            <h3>üéØ Recommended Roles</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem;">
                {% for role, count in stats.recommended_roles %}
                <span style="background: #dbeafe; color: #1e40af; padding: 0.375rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500;">
                    {{ role|title }}{% if count > 1 %} <span style="opacity: 0.7;">({{ count }})</span>{% endif %}
                </span>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if stats.average_by_category %}
        <div class="category-ratings">
            <h3>Average Ratings by Category</h3>
            <div class="rating-bars">
                {% for category, rating in stats.average_by_category.items() %}
                <div class="rating-bar-item">
                    <label>{{ category|title }}:</label>
                    <div class="rating-bar">
                        <div class="rating-fill" style="width: {{ (rating / 5 * 100)|int }}%"></div>
                    </div>
                    <span class="rating-value">{{ "%.2f"|format(rating) }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {% if trend_data %}
    <div class="trend-section">
        <h2>Performance Trend</h2>
        <div id="trend-chart"></div>
    </div>
    {% endif %}

    <div class="evaluations-section">
        <h2>All Evaluations</h2>
        {% if volunteer.evaluations.count() > 0 %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Event</th>
                    <th>Role</th>
                    <th>Evaluator</th>
                    <th>Overall</th>
                    <th>Reliability</th>
                    <th>Communication</th>
                    <th>Teamwork</th>
                    <th>Initiative</th>
                    <th>Quality</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for eval in evaluations %}
                <tr>
                    <td>{{ eval.evaluation_date.strftime('%Y-%m-%d') if eval.evaluation_date else eval.submitted_at.strftime('%Y-%m-%d') }}</td>
                    <td><strong>{{ eval.event_name or 'N/A' }}</strong></td>
                    <td><strong>{{ eval.role_performed or 'N/A' }}</strong></td>
                    <td>{{ eval.evaluator_name }}</td>
                    {% set overall = ((eval.reliability + eval.quality_of_work + eval.initiative + eval.teamwork + eval.communication) / 5.0) %}
                    <td><span class="rating-badge rating-{{ "%.0f"|format(overall) }}">{{ "%.1f"|format(overall) }}</span></td>
                    <td><span class="rating-badge rating-{{ eval.reliability }}">{{ eval.reliability }}</span></td>
                    <td><span class="rating-badge rating-{{ eval.communication }}">{{ eval.communication }}</span></td>
                    <td><span class="rating-badge rating-{{ eval.teamwork }}">{{ eval.teamwork }}</span></td>
                    <td><span class="rating-badge rating-{{ eval.initiative }}">{{ eval.initiative }}</span></td>
                    <td><span class="rating-badge rating-{{ eval.quality_of_work }}">{{ eval.quality_of_work }}</span></td>
                    <td>
                        <div class="action-buttons">
                            <a href="{{ url_for('dashboard.view_evaluation', evaluation_id=eval.id) }}" class="btn btn-small btn-secondary">üëÅÔ∏è View</a>
                            {% if current_user.role == 'admin' %}
                            <button onclick="deleteEvaluation({{ eval.id }})" class="btn btn-small btn-danger">üóëÔ∏è Delete</button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% if eval.strengths or eval.areas_for_improvement or eval.additional_comments or eval.would_work_again or eval.recommended_roles %}
                <tr class="feedback-row">
                    <td colspan="11" style="background: #f8fafc; padding: 1rem;">
                        <div style="max-width: 800px;">
                            {% if eval.strengths %}
                            <div class="feedback-item" style="margin-bottom: 0.75rem;">
                                <strong style="color: #059669;">üí™ Strengths:</strong> {{ eval.strengths }}
                            </div>
                            {% endif %}
                            {% if eval.areas_for_improvement %}
                            <div class="feedback-item" style="margin-bottom: 0.75rem;">
                                <strong style="color: #dc2626;">üìà Areas for Improvement:</strong> {{ eval.areas_for_improvement }}
                            </div>
                            {% endif %}
                            {% if eval.additional_comments %}
                            <div class="feedback-item" style="margin-bottom: 0.75rem;">
                                <strong style="color: #2563eb;">üí¨ Additional Comments:</strong> {{ eval.additional_comments }}
                            </div>
                            {% endif %}
                            {% if eval.would_work_again %}
                            <div class="feedback-item" style="margin-bottom: 0.75rem;">
                                <strong style="color: #6366f1;">ü§ù Would Work With Again:</strong>
                                {% if eval.would_work_again == 'Yes' %}
                                    <span style="color: #16a34a; font-weight: 600;">{{ eval.would_work_again }}</span>
                                {% elif eval.would_work_again == 'No' %}
                                    <span style="color: #dc2626; font-weight: 600;">{{ eval.would_work_again }}</span>
                                {% else %}
                                    <span style="color: #ea580c; font-weight: 600;">{{ eval.would_work_again }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% if eval.recommended_roles %}
                            <div class="feedback-item">
                                <strong style="color: #8b5cf6;">üéØ Recommended Future Roles:</strong> {{ eval.recommended_roles }}
                            </div>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="no-data">No evaluations submitted for this volunteer yet.</p>
        {% endif %}
    </div>

    <div class="profile-actions">
        <a href="{{ url_for('dashboard.index') }}" class="btn btn-secondary">Back to Dashboard</a>
        {% if current_user.role == 'admin' %}
        <form method="POST" action="{{ url_for('dashboard.delete_volunteer', volunteer_id=volunteer.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this volunteer and all their evaluations? This cannot be undone.');">
            <button type="submit" class="btn btn-danger">üóëÔ∏è Delete Volunteer</button>
        </form>
        {% endif %}
    </div>
</div>

<script>
function deleteEvaluation(evaluationId) {
    if (confirm('Are you sure you want to delete this evaluation?\n\nThis action cannot be undone.')) {
        fetch('/dashboard/evaluation/' + evaluationId + '/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Evaluation deleted successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error deleting evaluation. Please try again.');
            console.error(error);
        });
    }
}
</script>
{% endblock %}
